<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lesson-5-task-3</title>
</head>
<style>
    :root {
        --padding: 7px;
    }

    h3 {
        padding-left: var(--padding);
    }

    .goods-list {
        background-color: aquamarine;
    }

    .content {
        display: flex;
    }

    .block {
        width: 100px;
        height: auto;
        border-bottom: 1px solid #000;
        align-items: center;
        padding: var(--padding);
    }

    .block-name {
        flex-grow: 2;
    }

    .block-name {
        flex-grow: 1;
    }
</style>

<body>
<div class="goods-list"></div>
<button class="btn-clear">Очистить корзину</button>

<div class="catalog"></div>
<script>
// 1. Доработать модуль корзины.
// a. Добавлять в объект корзины выбранные товары по клику на кнопке «Купить» без перезагрузки страницы
// b. Привязать к событию покупки товара пересчет корзины и обновление ее внешнего вида

    const catalog = {
        settings: {
            catalogBlock: document.body.querySelector('.catalog')
        },

        products: [
            {
                product_name: "Ноутбук",
                price: 45600,
                idProduct: '111',
                quantity: 1
            },
            {
                product_name: "Мышка",
                price: 1000,
                idProduct: '112',
                quantity: 1
            },
            {
                product_name: "Монитор",
                price: 15000,
                idProduct: '113',
                quantity: 1
            },
            {
                product_name: "Клавиатура",
                price: 3400,
                idProduct: '114',
                quantity: 1
            },
            {
                product_name: "Кресло компьютерное",
                price: 5600,
                idProduct: '115',
                quantity: 1
            }
        ],

        initCatalog() {
            let tableCatalogHTML = `<h1>Каталог товаров</h1>
            <div class="content">
              <div class="block block-name"><b>Наименование товара</b></div>
              <div class="block block-quantity"><b>Код товара</b></div>
              <div class="block"><b>Цена</b></div>
              <div class="block"></div>
            </div>
          `;
            this.products.forEach((product) => {
                tableCatalogHTML += `<div class="content card">
                      <div class="block block-name">${product.product_name}</div>
                      <div class="block block-quantity">${product.idProduct}</div>
                      <div class="block">${product.price}</div>
                      <div class="block"><button class="cart-btn" data-product_id="${product.idProduct}">В корзину</button></div>
                  </div>`
            });
            this.settings.catalogBlock.innerHTML = tableCatalogHTML;
        },

        clickBtn() {
            // Навешиваем ОДИН обработчик на весь контейнер
            this.settings.catalogBlock.addEventListener('click', event => {
                if (!event.target.matches('BUTTON')) return
                const id = event.target.dataset.product_id  // ID товара
                this.searchForDuplicates(id);
            })
        },

        // Проверяем - находится такой товар уже в корзине или нет
        searchForDuplicates(id) {
            const indexProductBasket = basket.goods.findIndex(product => product.idProduct === id);
            if (indexProductBasket !== -1) {  // Если есть, просто увеличиваем количество товара в корзине
                basket.goods[indexProductBasket].quantity += 1;
                basket.initBasket();
            } else {
                this.productSearchByID(id)  // Иначе, создаем новый объект товара в корзине
            }
        },

        productSearchByID(id) { // Поиск индекса товара в массиве каталога по ID товара
            const indexProduct = this.products.findIndex(product => product.idProduct === id);
            this.newProductForBasket(indexProduct)
        },

        newProductForBasket(index) {  // Создаем "копию" товара из каталога
            let newProduct = JSON.parse(JSON.stringify(this.products[index]));
            basket.goods.push(newProduct); // Добавляем в корзину
            basket.initBasket();
        },

        init() {
            this.clickBtn();
            this.initCatalog();
        }
    }

    const basket = {
        goodsBlock: null,
        clearCartButton: null,
        goods: [
            {
                product_name: "Ноутбук",
                price: 45600,
                idProduct: '111',
                quantity: 1
            },
            {
                product_name: "Мышка",
                price: 1000,
                idProduct: '112',
                quantity: 3
            },
            {
                product_name: "Монитор",
                price: 15000,
                idProduct: '113',
                quantity: 3
            }
        ],

        initBasket() {
            const goodsBlock = document.querySelector('.goods-list');
            let tableGoodsHTML = `<h1>Корзина</h1>
            <div class="content">
                <div class="block block-name"><b>Наименование товара</b></div>
                <div class="block block-quantity"><b>Количество</b></div>
                <div class="block"><b>Цена</b></div>
            </div>
          `;
            this.goods.forEach((good) => {
                tableGoodsHTML += `<div class="content">
                      <div class="block block-name">${good.product_name}</div>
                      <div class="block block-quantity">${good.quantity}</div>
                      <div class="block">${good.price}</div>
                  </div>`
            });
            goodsBlock.innerHTML = tableGoodsHTML;

            // Итоговое сообщение
            const messageBasket = document.createElement('h3');
            messageBasket.textContent = this.message();
            goodsBlock.appendChild(messageBasket);


            this.clearCartButton = document.querySelector('.btn-clear');
            this.clearCartButton.addEventListener('click', () => this.clearCart());
        },

        message() {
            let msg = '';
            if (this.countBasketQuantity() === 0) msg = "Корзина пуста";
            else {
                msg = `В корзине: ${this.countBasketQuantity()} товаров на сумму ${this.countBasketPrice()} рублей`;
            }
            return msg;
        },

        countBasketPrice() {
            return this.goods.reduce((totalPrice, cartItem) => totalPrice + cartItem.price * cartItem.quantity, 0);
        },

        countBasketQuantity() {
            return this.goods.reduce((totalQuantity, cartItem) => totalQuantity + cartItem.quantity, 0);
        },

        clearCart() {
            this.goods = [];
            this.initBasket();
        }
    };

    basket.initBasket();
    catalog.init();
</script>
</body>

</html>